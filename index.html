<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to JSON Converter</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">CSV to JSON Converter</h2>
        <p class="text-muted">To get the client identifier, go to AMS and find your site's organization. Then click on the button "Export Glossary". Open it with a text editor and copy the client identifier from there.</p>
        <input type="file" id="csvFileInput" accept=".csv" class="form-control mb-3">
        <a id="parseButton" class="btn btn-primary mb-3" role="button">Parse CSV</a>
        <div id="languageMapping" class="mt-4" style="display: none;"></div>
        <a id="downloadJsonButton" class="btn btn-secondary mt-3" style="display: none;" role="button">Download JSON</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        const languageCodeMapping = {
            "ar": "Arabic",
            "zh-Hans": "Simplified Chinese",
            "fr": "French",
            "de": "German",
            "el": "Greek",
            "he": "Hebrew",
            "it": "Italian",
            "ja": "Japanese",
            "ko": "Korean",
            "nl": "Dutch",
            "pl": "Polish",
            "pt-PT": "Portuguese (Portugal)",
            "pt-BR": "Portuguese (Brazil)",
            "ru": "Russian",
            "sv": "Swedish",
            "es": "Spanish",
            "th": "Thai",
            "vi": "Vietnamese"
        };

        document.getElementById('parseButton').addEventListener('click', () => {
            const fileInput = document.getElementById('csvFileInput');
            if (fileInput.files.length === 0) {
                alert('Please select a CSV file to parse.');
                return;
            }
            const clientIdentifier = prompt('Please enter the client identifier:');
            if (!clientIdentifier) {
                
                resetApplication();
                return;
            }
            const file = fileInput.files[0];
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    processCsv(results.data);
                    const json = generateJson(results.data, clientIdentifier);
                    const jsonString = JSON.stringify(json, null, 2);
                    enableDownload(jsonString);
                }
            });
        });

        function processCsv(data) {
            const languageMappingDiv = document.getElementById('languageMapping');
            languageMappingDiv.style.display = 'block';
            languageMappingDiv.innerHTML = '';

            const languages = Object.keys(data[0]).filter(key => key !== 'en');
            languages.forEach(language => {
                const label = document.createElement('label');
                label.textContent = `Map CSV language code "${language}" to:`;
                label.classList.add('form-label', 'mt-3');

                const select = document.createElement('select');
                select.classList.add('form-select', 'mb-3');

                Object.entries(languageCodeMapping).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${name} (${code})`;
                    if (code === language) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Add New Language Code';
                select.appendChild(customOption);

                select.addEventListener('change', () => {
                    if (select.value === 'custom') {
                        const newCode = prompt('Enter new language code:');
                        if (newCode) {
                            const newOption = document.createElement('option');
                            newOption.value = newCode;
                            newOption.textContent = `Custom (${newCode})`;
                            select.insertBefore(newOption, customOption);
                            newOption.selected = true;
                        }
                    }
                });

                languageMappingDiv.appendChild(label);
                languageMappingDiv.appendChild(select);
            });
        }

        function resetApplication() {
            document.getElementById('csvFileInput').value = '';
            document.getElementById('languageMapping').innerHTML = '';
            document.getElementById('languageMapping').style.display = 'none';
            document.getElementById('downloadJsonButton').style.display = 'none';
        }

        function generateJson(data, clientIdentifier) {
            const json = {
                client_identifier: clientIdentifier,
                en: {}
            };

            data.forEach(row => {
                const term = row['en'];
                const translations = [];
                const kind = guessKind(term);

                Object.keys(row).forEach(langCode => {
                    if (langCode !== 'en' && row[langCode]) {
                        translations.push({ [langCode]: row[langCode] });
                    }
                });

                json.en[term] = {
                    description: null,
                    kind: kind,
                    translations: translations
                };
            });

            return json;
        }

        function guessKind(term) {
            // Apply the rules provided: if term is always the same, it's a "name"
            return term.match(/^[A-Z]/) ? "name" : "general";
        }

        function enableDownload(jsonString) {
            const downloadButton = document.getElementById('downloadJsonButton');
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            downloadButton.href = url;
            downloadButton.download = 'translated_terms.json';
            downloadButton.style.display = 'block';
        }
    </script>
</body>
</html>
